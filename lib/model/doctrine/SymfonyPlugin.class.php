<?php

/**
 * SymfonyPlugin
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 5925 2009-06-22 21:27:17Z jwage $
 */
class SymfonyPlugin extends BaseSymfonyPlugin
{
  protected $_rating, $_num_votes;
  
  public function getRoute()
  {
    return '@plugin?title='.$this['title'];
  }
  
  public function getRatingInfo()
  {
    $q = Doctrine::getTable('Comment')
              ->createQuery('c')
              ->select('AVG(c.rating) as average, COUNT(c.rating) as num_votes')
              ->innerJoin('c.SymfonyPluginComment pc')
              ->where('pc.id = ?', $this['id']);

    $result = $q->fetchOne();

    return $result;
  }
  
  public function setRatingInfo()
  {
    $info = $this->getRatingInfo();
    $this->_rating = $info['average'];
    $this->_num_votes = $info['num_votes'];
  }
  
  public function getRating()
  {
    if (!$this->_rating) 
    {
      $this->setRatingInfo();
    }
    return $this->_rating;
  }
  
  public function getNumVotes()
  {
    if (!$this->_num_votes) 
    {
      $this->setRatingInfo();
    }
    return $this->_num_votes;
  }
  
  public function getIndexableTitle()
  {
    // Translate camel-cased word to lowercased and spaced
    $index = csInflector::indexize($this['title']);
    
    // remove plugin prefix
    // $index = substr($index, strpos($index, ' '));
    
    // remove ending "plugin"
    $index = substr($index, 0, (strlen($index)-6));
    
    // trim
    $index = trim($index);
    
    return $index;
  }
  
  public function preInsert($event)
  {
    // Sets default repo url for new plugins
    
    if (!$this['repository_url']) 
    {
      $this['repository_url'] = $this->getSymfonyRepositoryUrl();
    }
  }

  public function getSymfonyRepositoryUrl()
  {
    return 'http://svn.symfony-project.com/plugins/'.$this['title'];
  }
  
  public function getSymfonyPluginsUrl()
  {
    return 'http://www.symfony-project.org/plugins/'.$this['title'];
  }
}